# Google Trends Dashboard

# https://shiny.rstudio.com/articles/plot-caching.html

END_DATE_TEXT <- "October 31, 2020"
END_DATE <- "2020-10-31"

# PACKAGES AND SETUP ===========================================================

#### Setting directory so will work locally
if (Sys.info()[["user"]] == "robmarty") {
  setwd("~/Documents/Github/covid-social-media-analysis/Dashboards/google_trends")
}

if (Sys.info()[["user"]] == "WB521633") {
  setwd("C:/Users/wb521633/Documents/Github/covid-social-media-analysis/Dashboards/google_trends")
}

#### Pacakges
library(sparkline)
library(shinydashboard)
library(RColorBrewer)
library(shinythemes)
library(DT)
library(dplyr)
library(rmarkdown)
library(lubridate)
library(shiny)
#library(wesanderson)
library(ggplot2)
#library(ggtext)
library(tidyr)
library(shinyWidgets)
#library(zoo)
#library(cowplot)
library(bcrypt)
library(shinyjs)
library(ngram)
library(stringdist)
library(stringr)
library(rgdal)
library(rgeos)
library(geosphere)
library(htmlwidgets)
library(tidyverse)
library(sf)
library(tidyverse)
library(raster)
library(leaflet)
library(leaflet.extras)
library(plotly)
library(formattable)
library(tidyr)
library(viridis)
library(data.table)
library(raster)
library(htmltools)
library(scales)
library(lubridate)
library(geosphere)
library(hrbrthemes)
#hrbrthemes::import_roboto_condensed()
shinyOptions(cache = diskCache("./cache"))

# Functions --------------------------------------------------------------------
as.character.htmlwidget <- function(x, ...) {
  htmltools::HTML(
    htmltools:::as.character.shiny.tag.list(
      htmlwidgets:::as.tags.htmlwidget(
        x
      ),
      ...
    )
  )
}

add_deps <- function(dtbl, name, pkg = name) {
  tagList(
    dtbl,
    htmlwidgets::getDependency(name, pkg)
  )
}

# Prep Objects -----------------------------------------------------------------
cor_after_dates <- c("2020-02-01",
                     "2020-03-01",
                     "2020-04-01",
                     "2020-05-01",
                     "2020-06-01",
                     "2020-07-01",
                     "2020-08-01")



# Defaults
gtrends_df <- readRDS(file.path("data", paste0("gtrends_since_",cor_after_dates[1],".Rds")))
gtrends_spark_df <- readRDS(file.path("data", paste0("gtrends_spark_since_",cor_after_dates[1],"_large.Rds")))
cor_df     <- readRDS(file.path("data", paste0("correlations_since_",cor_after_dates[1],".Rds")))
world      <- readRDS(file.path("data", "world.Rds"))
#world <- thinnedSpatialPoly(world, tol=15, topologyPreserve=T)

# Needed for keyword_cor
cor_neg1_pos1_df <- seq(from=-1, to=1, by=.1) %>%
  as.data.frame() %>%
  dplyr::rename(cor = ".") %>%
  mutate(cor = cor %>% as.factor())

LOAD_GTRENDS_INIT <- TRUE

keyword_list <- gtrends_df$keyword_en %>% unique()

keywords_df <- readRDS(file.path("data", "covid_keywords.Rds"))
languges_df <- read_csv(file.path("data", "countries_lang.csv"))

## Prep keywords
keywords_df$keyword_en <- keywords_df$keyword_en %>% tools::toTitleCase()
keywords_df <- keywords_df[keywords_df$keyword_en %in% gtrends_df$keyword_en,]
keywords_df$category <- keywords_df$category %>% tools::toTitleCase() 

keywords_clean_df <- keywords_df %>%
  dplyr::rename(Portuguese = keyword_pt,
                English = keyword_en,
                Spanish = keyword_es,
                French = keyword_fr,
                Arabic = keyword_ar,
                German = keyword_de,
                Mandarin = keyword_zh,
                Dutch = keyword_nl,
                Italian = keyword_it,
                Norwegian = keyword_no,
                Swedish = keyword_sv,
                Russian = keyword_ru,
                Greek = keyword_el,
                Turkish = keyword_tr) %>%
  dplyr::filter(scrape %in% c("yes")) %>%
  dplyr::select(English, Spanish, Portuguese, French, Arabic, German, Mandarin,
                Dutch, Italian, Norwegian, Swedish, Russian, Greek, Turkish) 

# FUNCTIONS ========
gtpath <- ""

# https://stackoverflow.com/questions/49885176/is-it-possible-to-use-more-than-2-colors-in-the-color-tile-function
color_tile2 <- function (...) {
  formatter("span", style = function(x) {
    style(display = "block",
          padding = "0 4px", 
          font.weight = "bold",
          `border-radius` = "4px", 
          `background-color` = csscolor(matrix(as.integer(colorRamp(...)(normalize(as.numeric(x)))), 
                                               byrow=TRUE, dimnames=list(c("red","green","blue"), NULL), nrow=3)))
  })}

# UI -==========================================================================
ui <- fluidPage(
  
  tags$head(includeHTML(("google-analytics-1.html"))),
  tags$head(includeHTML(("google-analytics-2.html"))),
  
  navbarPage(
    theme = shinytheme("cosmo"), #cosmo, journal, flatly, sandstone
    collapsible = TRUE,
    title = "COVID-19 & Google Trends",
    
    id = "nav",
    
    # ** Landing Page ----------------------------------------------------------
    tabPanel(
      "Overview",
      tags$head(includeCSS("styles.css")),
      
      
      dashboardBody(
        
        fluidRow(
          column(12, align = "center",
                 #h1("Google Trends Data for Understanding COVID-19")
                 h1("The Evolution of the Pandemic Through the Lens of Google Searches"),
                 h2("A Global Dashboard for Monitoring COVID-19")
          )
        ),
        
        fluidRow(
          column(6, align = "center", offset = 3,
                 
                 hr(),
                 h2("Overview")
          ),
          column(6, align = "left", offset = 3,
                 
                 HTML(paste0("<h4>When we fall ill, 
                 <a href='https://blog.google/technology/health/using-symptoms-search-trends-inform-covid-19-research/'>many of us turn to Google</a>
                 to understand our symptoms and treatment options.
                    Using data from February 1 - ",END_DATE_TEXT,", this dashboard illustrates how search interest for specific symptoms
                    strongly matches - and often preceeds - trends in COVID-19 cases.</h4>")),
                 br(),
                 
                 # 
                 HTML("<h4>Trends in search interest in COVID-19 symptoms should not replace
                 administrative data on cases. The relation between the two is strong
                 but <a href='https://www.nature.com/news/when-google-got-flu-wrong-1.12413'>not perfect</a>.
                 Search interest can be driven by 
                 <a href='https://www.sciencedirect.com/science/article/pii/S1201971220304641'>news or other events</a>, 
                 and the usefulness of search interest data depends on geographic characteristics such as internet access.
                 However, Google data can supplement official data.
                This is particularly true in circumstances
                    when testing or data may not be widely available. Moreover, given that
                    Google trends information is updated in real time, sudden increases in 
                    search interest can warn of potential growth in COVID-19 cases.</h4>"),
                 
                 br(),
                 HTML("<h4>Google Trends can also be used to understand impacts of COVID-19 
                      and search interest around prevention measures. Consequently, in addition 
                      to showing search interest in COVID-related symptoms, the dashboard also 
                      shows search interest related to 
                      <a href='https://psycnet.apa.org/fulltext/2020-59192-001.html'>mental health keywords</a> 
                      (e.g., anxiety and loneliness), other potential consequences (e.g., <a href='https://www.chicagofed.org/publications/blogs/chicago-fed-insights/2020/closer-look-google-trends-unemployment'>unemployment</a> and debt), 
                      prevention measures (e.g., face masks) and treatment measures (e.g., teleworking 
                      and ventilators).</h4>")
                 
                 
                 
                 
                 
                 
                 
          )
        ),
        fluidRow(
          column(6, align = "center", offset = 3,
                 hr(),
                 h2("Determining when the correlation between Google search interest and COVID-19 is strongest")
          ),
          column(6, align = "left", offset = 3,
                 HTML("<h4>In all figures and analysis, we use the number of new daily COVID-19 cases or deaths
                      and a 7 day moving average of Google Search Interest. We compute how strongly different 
                      search terms correlate with COVID-19 cases and deaths. In addition, we determine whether 
                      search interest can help predict future cases or deaths
                      or whether search interest responds or comes after cases/deaths. To determine this, we shift COVID-19 cases/deaths
                      by up to 21 days from its actual date. We calculate the correlation between
                      the shifted COVID-19 and the search interest (this approach follows 
                      <a href='https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7176069/'>research</a>
                      <a href='https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7438693/'>from</a>
                      <a href='https://www.sciencedirect.com/science/article/pii/S1201971220302496'>others</a>
                      on COVID-19 and Google Trends). Using all these estimated correlations, we determine the 
                      following metrics:</h4>")
                 # HTML("<h4>For each search term, we seek to understand (1) the strength of the correlation
                 #      between COVID-19 cases/deaths and Google search term interest and (2) when the correlation
                 #      is strongest.</h4"),
                 # br(),
                 # HTML("<h4>We shift search interest by up to 21 days from its actual date. We calculte the correlation
                 #      between COVID cases/deaths and the shifted search interest. The following values are determined:</h4>")
          )
        ),
        fluidRow(
          column(6, align = "left", offset = 3,
                 HTML("<ul>
                      <li><h4><b>Maximum Correlation</b></h4></li>
                      <li><h4><b>Lead/Lag Days:</b> The number of days COVID-19 cases/deaths was shifted to obtain the maximum correlation.
                      <b>Negative values</b> mean that search interest comes before COVID-19, helping to predict cases/deaths while
                      <b>positive values</b> indicate the search interest reacts to COVID-19 cases/deaths</h4></li>
                      </ul>"),
                 
                 br()
          )
        ),
        
        fluidRow(
          column(12, align = "center",
                 HTML("<strong>Correlation between <span style='color:orange;'>COVID-19 cases</span> (shifted) and <span style='color:green;'>Search Term Interest</span></strong>")
          )
        ),
        fluidRow(
          column(12, align = "center",
                 img(src="cor.gif", width='70%')
          )
        ),
        
        br(),
        br(),
        br(),
        br(),
        br(),
        br(),
        br(),
        br(),
        br()
        
        
        # fluidRow(
        #   column(6, align = "center", offset = 3,
        #          hr(),
        #          h2("Example"),
        #          
        #          h4("As an example, growth in the search popularity of 'Loss of Smell'
        #             preceded an increase in COVID-19 cases by about 10 days in the 
        #             United States in mid-June. The 
        #             dashboard shows this trend holds across many countries.")
        #   )
        # ),
        # 
        # fluidRow(
        #   #column(12,
        #   #       ),
        #   column(12, align = "center",
        #          
        #          plotOutput("us_ex_fig",
        #                     height = "350px",
        #                     width = "700px")
        #          
        #   )
        #   #column(2,
        #   #),
        #   
        #   
        # )
        
      )
    ),
    
    # ** Global Level ----------------------------------------------------------
    tabPanel(
      "Global Level",
      tags$head(includeCSS("styles.css")),
      
      dashboardBody(
        
        # fluidRow(
        #   column(6, align = "center", offset = 3,
        #          HTML("<b><em>Choose to examine COVID cases or deaths, restrict the analysis to
        #                 a specific continent, only consier the correlation between COVID-19 and search
        #               interest after a specific date and restrict to a select category of keywords.</em></b>")
        #   ),
        # ),
        # 
        # br(),
        
        fluidRow(
          column(3, align = "center", offset = 0,
                 selectInput(
                   "select_continent",
                   label = strong("Continent"),
                   choices = c("All",
                               unique(sort(cor_df$continent))),
                   selected = "All",
                   multiple = F
                 )
          ),
          column(2, align = "center",
                 selectInput(
                   "select_covid_type",
                   label = strong("Cases/Deaths"),
                   choices = c("Cases", "Deaths"),
                   selected = "Cases",
                   multiple = F
                 )
          ),
          column(2, align = "center",
                 selectInput(
                   "select_cor_type",
                   label = strong("Correlation"),
                   choices = c("Best Lead/Lag", "No Lead/Lag"),
                   selected = "Best Lead/Lag",
                   multiple = F
                 )
          ),
          column(2, align = "center",
                 selectInput(
                   "select_begin_date",
                   label = strong("Correlation After"),
                   choices = cor_after_dates,
                   selected = "2020-02-01",
                   multiple = F
                 )
          ),
          column(3, align = "center",
                 selectInput(
                   "select_search_category",
                   label = strong("Search Term Categories"),
                   choices = c("All",
                               sort(unique(keywords_df$category))),
                   selected = "Symptoms",
                   multiple = F
                 )
          )
          
          
        ),
        
        
        
        hr(),
        
        h2(textOutput("which_keyword_title"),
           align = "center"),
        
        
        
        
        fluidRow(
          column(6, offset = 3,
                 wellPanel(id = "tPanel",style = "overflow-y:scroll; max-height: 500px",
                           fluidRow(
                             column(12, align = "center", offset = 0,
                                    htmlOutput("cor_distribution_text"),
                             ),
                             #column(1,
                             #)
                           ),
                           fluidRow(
                             column(10, align = "center", offset = 1,
                                    htmlOutput("cor_distribution_text_2"),
                             ),
                             column(1,
                             )
                           ),
                           fluidRow(
                             uiOutput("max_cor_hist_ui")
                           )
                 ),
          ),
        ),
        
        hr(),
        
        fluidRow(
          
          column(4, align = "center", offset = 4,
                 #tags$style("#select_keyword_ui {color: green;}"),
                 uiOutput("select_keyword_ui")
                 
                 
                 
          )
          
        ),
        
        fluidRow(
          column(4, align = "center", offset = 4,
                 htmlOutput("title_cor_lag")
          )
        ),
        
        fluidRow(
          column(4, align = "center", offset = 2,
                 plotOutput("keyword_cor", height = "130px")
          ),
          column(4, align = "center",
                 plotOutput("keyword_lag", height = "130px")
          )
        ),
        
        tabsetPanel(type = "tabs",
                    
                    tabPanel(tags$div( 
                      
                      HTML(paste(tags$span(style="color:white", "--------------------------------------------------------------------------------------"), sep = "")) 
                      
                    )),
                    
                    tabPanel(id = "map_view",
                             "Map View", 
                             
                             br(),
                             fluidRow(
                               column(12, align = "center",
                                      htmlOutput("map_text")
                               )
                             ),
                             fluidRow(
                               column(12, align = "center",
                                      HTML(paste0("<em>Trends shown from February 1 - ", END_DATE_TEXT, "</em>"))
                               )
                             ),
                             
                             br(),
                             
                             fluidRow(
                               column(12, align = "center", offset = 0,
                                      uiOutput("cor_map_leaflet")
                                      
                               )
                             )
                             
                    ),
                    tabPanel(id = "table_view",
                             "Table View",
                             
                             br(),
                             
                             fluidRow(
                               column(12, align = "center",
                                      htmlOutput("global_table_title")
                               )
                             ),
                             fluidRow(
                               column(12, align = "center",
                                      HTML(paste0("<em>Trends shown from February 1 - ", END_DATE_TEXT, "</em>"))
                               )
                             ),
                             
                             br(),
                             
                             fluidRow(
                               column(4,
                               ),
                               column(4,align = "center",
                                      uiOutput("ui_select_sort_by")
                               ),
                               column(4,
                               )
                             ),
                             
                             fluidRow(
                               
                               column(8, align = "center", offset = 2,
                                      htmlOutput("line_graph"),
                               )
                               
                             )
                             
                             
                    ), selected = "Map View"),
        
        fluidRow(
          column(12, align = "center",
                 
                 #strong(htmlOutput("dummy_spark"))
                 
          )
        )
        
      )
    ),
    
    # ** Country Level ----------------------------------------------------------
    tabPanel(
      id = "country_level",
      "Country Level",
      tags$head(includeCSS("styles.css")),
      
      dashboardBody(
        
        fluidRow(
          column(3, align = "center", offset = 0,
                 
                 uiOutput("select_country_ui")
                 
                 # selectizeInput(
                 #   "select_country",
                 #   label = strong("Select Country"),
                 #   choices = c("", sort(cor_df$name)),
                 #   selected = "",
                 #   multiple = F
                 # )#,
          ),
          column(2, align = "center", offset = 0,
                 selectInput(
                   "select_covid_type_map",
                   
                   label = strong(HTML("Cases/Deaths")),
                   choices = c("Cases", "Deaths"),
                   selected = "Cases",
                   multiple = F
                 )
          ),
          column(2, align = "center",
                 selectInput(
                   "select_cor_type_country",
                   label = strong("Correlation"),
                   choices = c("Best Lead/Lag", "No Lead/Lag"),
                   selected = "Best Lead/Lag",
                   multiple = F
                 )
          ),
          column(2, align = "center",
                 selectInput(
                   "select_begin_date_country",
                   label = strong("Correlation After"),
                   choices = cor_after_dates,
                   selected = "2020-02-01",
                   multiple = F
                 )
          ),
          column(3, align = "center",
                 selectInput(
                   "select_search_category_country",
                   label = strong("Search Term Categories"),
                   choices = c("All",
                               sort(unique(keywords_df$category))),
                   selected = "Symptoms",
                   multiple = F
                 )
          )
        ),
        
        #br(),
        
        fluidRow(
          column(12, align = "center",
                 h3(textOutput("country_name"))
          )
        ),
        
        fluidRow(
          column(6, align = "center", offset = 3,
                 strong(htmlOutput("trends_country_subtitle"), align="center"),
          )
        ),
        
        br(),
        
        fluidRow(
          column(8, align = "center", offset = 2,
                 div(style = 'overflow-y: scroll; height:300px', htmlOutput("line_graph_country"))
          )
        ),
        hr(),
        
        wellPanel(
          fluidRow(
            column(4, align = "center", offset = 4,
                   uiOutput("select_keyword_country_ui")
            )
          ),
          
          fluidRow(
            column(6, align = "center", offset = 3,
                   htmlOutput("translation_text")
            )
          ),
          
          fluidRow(
            column(5, align = "center",
                   h3("Historic Trends"),
                   strong(paste0("Data Available Until ", END_DATE_TEXT))
            ),
            column(7, align = "center",
                   h3("Real Time Data: Search Interest in Past 90 Days"),
                   fluidRow(
                     column(8, align = "center", offset = 2,
                            HTML("<strong>Trends at different time spans and at subnational levels can be
                            explored on the 
                            <a href='https://trends.google.com/trends/'>Google Trends website.</a></strong>")
                     )
                   )
            )
          ),
          
          fluidRow(
            column(5, align = "left", 
                   #br(),
                   # fluidRow(
                   #   column(12, align = "center",
                   #          htmlOutput("line_graph_country_key_title_1")
                   #          )
                   # ),
                   # fluidRow(
                   #   column(10, align = "left", offset = 1,
                   #          htmlOutput("line_graph_country_key_title_2")
                   #   )
                   # ),
                   
                   #div(style='color:green; font-size:20px; background-color: white; border: 1px solid #ccc; border-radius: 3px; margin: 10px 0; padding: 10px; width: 700px',
                   div(style='color:black; font-size:20px; background-color: white; border: 1px solid #ccc; border-radius: 3px; margin: 10px 0; padding-left: 16px; padding-right: 16px; padding-bottom: 5px; padding-top: 0px;',
                       
                       fluidRow(
                         column(12, align = "left", offset = 0,
                                htmlOutput("line_graph_country_key_title_2")
                         )
                       ),

                       fluidRow(
                         plotlyOutput("line_graph_country_key",
                                      height = "270px") # 225
                       ),
                       fluidRow(
                         column(11, offset = 1, align = "left",
                                h6("We compute a 7 day moving average of Google search interest.
                               Original daily values range from 0 to 100, where 100 represents
                               peak search activity for a keyword.") 
                         )
                       )
                       
                   ),
                   
            ),
            column(4, align = "center",
                   tags$div(id="wrapper"),
                   
                   uiOutput("gtrends_html_trends")
            ),
            column(3, align = "center",
                   tags$div(id="wrapper2"),
                   uiOutput("gtrends_html_map")
            )
          )
        )
      )
    ),
    
    
    # ** Information -----------------------------------------------------------
    tabPanel(
      "Information",
      tags$head(includeCSS("styles.css")),
      
      dashboardBody(
        
        fluidRow(
          column(6, offset = 3,
                 h2("Data", align = "center"),
                 HTML("We access COVID-19 Cases and Deaths from the
                      <a href='https://covid19.who.int/?gclid=Cj0KCQjw8fr7BRDSARIsAK0Qqr73Wij8AiyjGx8dOs-MYxN7oxF5pzYmurbdVxj-x65Gc8tx1jJykaYaAqQNEALw_wcB'>WHO</a>
                      and download 
                      <a href='https://trends.google.com/trends/'>Google Trends </a>
                      data for all countries. In all analyses, we
                      use a 7 day moving average of Google Search interest. To protect privacy, Google
                      only releases search interest data when there is a large enough search volume for a
                      specific search term. We translate search terms from English into
                      each country's most widely used language using Google Translate.
                      The below table shows which language is used for each country."),
                 
          )
        ),
        fluidRow(
          br(),
          column(6, offset = 3, align = "center",
                 div(style = 'overflow-y: scroll; height:300px', tableOutput('language_table'))
          )
        ),
        
        fluidRow(
          column(6, offset = 3,
                 hr(),
                 h2("Subnational Case Study: Brazil", align = "center"),
                 HTML("While the dashboard shows country level results, the project
                 team also conducted a 
                 <a href='https://drive.google.com/file/d/1-DrtOdFdKCv99G-w3zHK0VyDK65GqEpJ/view?usp=sharing'>case study</a> 
                 of Google Search interest and 
                 COVID-19 at the subnational level in Brazil.")
          )
        ),
        
        fluidRow(
          column(6, offset = 3,
                 hr(),
                 h2("References", align = "center"),
                 
                 HTML("This dashboard builds off of a literature that
                      uses Google Trends to provide insight into COVID-19.
                      Articles that were used to inform the dashboard include
                      the following:"),
                 
                 
                 # <li><a href='URL'>TITLE</a></li>
                 HTML("<br><br><ul>
                      <li><a href='https://www.chicagofed.org/publications/blogs/chicago-fed-insights/2020/closer-look-google-trends-unemployment'>A Closer Look at the Correlation Between Google Trends and Initial Unemployment Insurance Claims</a></li>
                      <li><a href='https://www.sciencedirect.com/science/article/pii/S1201971220302496'>Association of the COVID-19 pandemic with Internet Search Volumes: A Google Trends(TM) Analysis</a></li>
                      <li><a href='https://www.washingtonpost.com/politics/2020/10/29/can-google-searches-predict-where-coronavirus-cases-will-soon-emerge/'>Can Google searches predict where coronavirus cases will soon emerge?</a></li>
                      <li><a href='https://www.mayoclinicproceedings.org/article/S0025-6196(20)30934-4/fulltext'>Correlations Between COVID-19 Cases and Google Trends Data in the United States: A State-by-State Analysis</a></li>
                      <li><a href='https://ideas.repec.org/p/cep/cepdps/dp1693.html'>COVID-19, Lockdowns and Well-being: Evidence from Google Trends</a></li>
                      <li><a href='https://europepmc.org/article/pmc/pmc7267744'>Predicting COVID-19 Incidence Using Anosmia and Other COVID-19 Symptomatology: Preliminary Analysis Using Google and Twitter</a></li>
                      <li><a href='https://www.nytimes.com/2020/04/05/opinion/coronavirus-google-searches.html'>Google Searches Can Help Us Find Emerging Covid-19 Outbreaks</a></li>
                      <li><a href='https://www.ncbi.nlm.nih.gov/pmc/articles/PMC7189861/'>The COVID-19 outbreak and Google searches: Is it really the time to worry about global mental health?</a></li>
                      <li><a href='https://pubmed.ncbi.nlm.nih.gov/32279437/'>Use of Google Trends to investigate loss-of-smell-related searches during the COVID-19 outbreak</a></li>
                      <li><a href='https://www.medrxiv.org/content/10.1101/2020.05.07.20093955v2'>Utility and limitations of Google searches for tracking disease: the case of taste and smell loss as markers for COVID-19</a></li>
                      </ul>"),
          )
        ),
        
        fluidRow(
          column(6, offset = 3,
                 hr(),
                 h2("Credits", align = "center"),

                 HTML(" The dashboard and analytics were produced by Robert Marty, Manuel Maqueda,
                 Nausheen Khan, Arndt Reichert and Bibind Vasu of the 
                 
                 <a href='https://www.worldbank.org/en/research/dime'>Development Impact Evaluation (DIME)</a>
                Group at the World Bank.
                      <br><br>
                      The findings, interpretations, and conclusions expressed in this dashboard are entirely those
                of the authors. They do not necessarily represent the views of the International Bank for Reconstruction and Development/World Bank and
                its affiliated organizations, or those of the Executive Directors of the World Bank or the governments they represent.")
                 

                
          )
        ),
        

        #Suggested citation: WHO COVID-19 Explorer. Geneva: World Health Organization, 2020. Available online: https://worldhealthorg.shinyapps.io/covid/ (last cited: [date]).
        
     # br(),
     # br(),
     #   
     #   fluidRow(
     #     column(4, align = "left", offset = 4,
     #            HTML("<h6><em>The findings, interpretations, and conclusions expressed in this dashboard are entirely those
     #            of the authors. They do not necessarily represent the views of the International Bank for Reconstruction and Development/World Bank and
     #            its affiliated organizations, or those of the Executive Directors of the World Bank or the governments they represent.</em></h6>"
     #            )
     #     )
     #     
     #   ),
       
       
       

        
        fluidRow(
          column(12,
                 br(),
                 br(),
                 br(),
                 br(),
                 br(),
                 br(),
                 br(),
                 br(),
                 br(),
                 br()
          )
        )
        
        
      )
    )
    
  )
)

# SERVER =======================================================================
server = (function(input, output, session) {
  
  # GLOBAL FIGURES ***************** -------------------------------------------
  
  # ** Global Correlation Map --------------------------------------------------
  output$cor_map_leaflet <- renderUI({
    
    gtrends_spark_df <- readRDS(file.path("data", paste0("gtrends_spark_since_",
                                                         input$select_begin_date,"_large.Rds")))
    
    #req(input$nav == "Map View") # This makes leaflet show up; before no defaults.
    
    if(input$select_cor_type %in% "No Lead/Lag"){
      gtrends_spark_df$cor_casesMA7_hitsMA7_max <- gtrends_spark_df$cor_casesMA7_hitsMA7_nolag
      gtrends_spark_df$cor_deathMA7_hitsMA7_max <- gtrends_spark_df$cor_deathMA7_hitsMA7_nolag
    }
    
    gtrends_spark_df$name <- NULL
    
    # Step 1 convert htmlwidget to character representation of HTML components
    
    
    #### Subset world
    if(input$select_continent != "All"){
      world <- world[world$continent %in% input$select_continent,]
      gtrends_spark_df <- gtrends_spark_df[gtrends_spark_df$continent %in% input$select_continent,]
      
    }
    
    #### Subset Keyword
    gtrends_spark_df <- gtrends_spark_df %>%
      dplyr::filter(keyword_en %in% input$select_keyword) 
    
    #### COVID Type
    if(input$select_covid_type %in% "Cases"){
      gtrends_spark_df$l_covid_hits <- gtrends_spark_df$l_cases_hits
      gtrends_spark_df$cor_covidMA7_hitsMA7_max <- gtrends_spark_df$cor_casesMA7_hitsMA7_max
      gtrends_spark_df$cor_covidMA7_hitsMA7_lag <- gtrends_spark_df$cor_casesMA7_hitsMA7_lag
      gtrends_spark_df$cor_covidMA7_hitsMA7_zscore <- gtrends_spark_df$cor_casesMA7_hitsMA7_zscore %>% round(3)
    } else{
      gtrends_spark_df$l_covid_hits <- gtrends_spark_df$l_death_hits
      gtrends_spark_df$cor_covidMA7_hitsMA7_max <- gtrends_spark_df$cor_deathMA7_hitsMA7_max
      gtrends_spark_df$cor_covidMA7_hitsMA7_lag <- gtrends_spark_df$cor_deathMA7_hitsMA7_lag
      gtrends_spark_df$cor_covidMA7_hitsMA7_zscore <- gtrends_spark_df$cor_deathMA7_hitsMA7_zscore %>% round(3)
    }
    
    #### Merge
    gtrends_spark_df <- gtrends_spark_df %>% distinct(geo, .keep_all=T) # TODO
    world_data <- merge(world, gtrends_spark_df, by = "geo", all.x=T, all.y=F)
    world_data <- world_data
    
    #### Prep Correlation
    world_data$cor <- ""
    world_data$cor[!is.na(world_data$cor_covidMA7_hitsMA7_max)] <-
      paste0("<br><b>Correlation:</b> ", world_data$cor_covidMA7_hitsMA7_max[!is.na(world_data$cor_covidMA7_hitsMA7_max)] %>%
               round(3))
    
    world_data$cor_lag <- ""
    world_data$cor_lag[!is.na(world_data$cor_covidMA7_hitsMA7_lag)] <-
      paste0("<br><b>Lead/Lag:</b> ", world_data$cor_covidMA7_hitsMA7_lag[!is.na(world_data$cor_covidMA7_hitsMA7_lag)], " days")
    
    world_data$cor_keyword <- ""
    world_data$cor_keyword[!is.na(world_data$keyword)] <-
      paste0("<b><em>", world_data$keyword[!is.na(world_data$keyword)], "</em></b>")
    
    world_data$l_covid_hits[is.na(world_data$l_covid_hits)] <- "<em>Low Google search interest<br>for this search term</em>"
    
    world_data$popup <- paste0("<h4>", world_data$name, "</h4>", 
                               world_data$cor_keyword,
                               world_data$cor, 
                               world_data$cor_lag, 
                               "<br>",
                               world_data$l_covid_hits)
    
    # https://stackoverflow.com/questions/61175878/r-leaflet-highcharter-tooltip-label
    pal <- colorNumeric(
      palette = "RdYlGn",
      domain = c(world_data$cor_covidMA7_hitsMA7_max[!is.na(world_data$cor_covidMA7_hitsMA7_max)], -1, 1))
    
    pal_rev <- colorNumeric(
      palette = "RdYlGn",
      domain = c(world_data$cor_covidMA7_hitsMA7_max[!is.na(world_data$cor_covidMA7_hitsMA7_max)], -1, 1),
      reverse = T)
    
    #aa <<- world_data
    
    # +proj=wintri
    # epsg2163 <- leafletCRS(
    #   crsClass = "L.Proj.CRS",
    #   #code = "EPSG:2163",
    #   code = "ESRI:54030",
    #   proj4def = "+proj=robin +lon_0=0 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs",
    #   #proj4def = "+proj=laea +lat_0=45 +lon_0=-100 +x_0=0 +y_0=0 +a=6370997 +b=6370997 +units=m +no_defs",
    #   resolutions = 2^(16:7))
    # options = leafletOptions(crs = epsg2163)
    
    # https://epsg.io/54030
    # crs_leaflet <- leafletCRS(
    #   crsClass = "L.Proj.CRS",
    #   code = "EPSG:4087",
    #   proj4def = "+proj=eqc +lat_ts=0 +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs ",
    #   resolutions = 1.55^(25:15))
    # 
    # crs_leaflet <- leafletCRS(
    #   crsClass = "L.Proj.CRS",
    #   code = "EPSG:4088",
    #   proj4def = "+proj=eqc +lat_ts=0 +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +a=6371007 +b=6371007 +units=m +no_defs",
    #   resolutions = 1.55^(25:15))
    
    # options = leafletOptions(crs = epsg2163)
    
    leaflet(height = "700px") %>%
      #addTiles() %>%
      addPolygons(data = world_data,
                  label = ~lapply(popup, HTML),
                  popupOptions = popupOptions(minWidth = 200,
                                              maxHeight = 150),
                  stroke = F,
                  smoothFactor = 0,
                  fillOpacity = 1,
                  color = ~pal(cor_covidMA7_hitsMA7_max)) %>%
      onRender("function(el,x) {
      this.on('tooltipopen', function() {HTMLWidgets.staticRender();})
    }") %>%
      #   onRender("function(el,x) {
      #   this.on('popupopen', function() {HTMLWidgets.staticRender();})
      # }") %>%
      addLegend("topright",
                pal = pal_rev,
                values = c(world_data$select_covid_type[!is.na(world_data$select_covid_type)], -1, 1),
                title = paste0("Correlation<br>between<br>",
                               input$select_covid_type,
                               " and<br>Search<br>Interest"),
                labFormat = labelFormat(transform = function(x) sort(x, decreasing = TRUE)),
                opacity = 1,
                bins = c(-1, -0.5, 0, 0.5, 1)) %>%
      setMapWidgetStyle(list(background= "white")) %>%
      setView(zoom = 2, lat=0, lng=0) %>%
      add_deps("sparkline") %>%
      #add_deps("highchart", 'highcharter') %>%
      browsable()
    #) #%>%
    #add_deps("sparkline") 
    #browsable() %>%
    #
    
  })
  
  # ** Sparkline Table ---------------------------------------------------------
  output$global_table_title <- renderText({
    paste0("<strong>The table shows trends in <span style='color:orange;'>COVID-19 ",
           tolower(input$select_covid_type),
           "</span> and <span style='color:green;'>search interest in '",
           input$select_keyword, "'</span></strong>")
  })
  
  
  output$line_graph <- renderUI({
    
    gtrends_spark_df <- readRDS(file.path("data", paste0("gtrends_spark_since_",
                                                         input$select_begin_date,"_large.Rds")))
    
    if(input$select_cor_type %in% "No Lead/Lag"){
      gtrends_spark_df$cor_casesMA7_hitsMA7_max <- gtrends_spark_df$cor_casesMA7_hitsMA7_nolag
      gtrends_spark_df$cor_deathMA7_hitsMA7_max <- gtrends_spark_df$cor_deathMA7_hitsMA7_nolag
    }
    
    #### Subset
    if(input$select_continent != "All"){
      gtrends_spark_df <- gtrends_spark_df %>%
        dplyr::filter(continent %in% input$select_continent) 
    }
    
    gtrends_spark_df <- gtrends_spark_df %>%
      filter(keyword_en %in% input$select_keyword)
    
    if(input$select_covid_type %in% "Cases"){
      gtrends_spark_df <- gtrends_spark_df %>%
        dplyr::select(name, l_cases_hits, 
                      cor_casesMA7_hitsMA7_max, 
                      cor_casesMA7_hitsMA7_lag,
                      cases_total) %>%
        dplyr::rename(Country = name,
                      Trends = l_cases_hits,
                      "Correlation" = cor_casesMA7_hitsMA7_max,
                      "Lead/Lag" = cor_casesMA7_hitsMA7_lag)
      
    } 
    if(input$select_covid_type %in% "Deaths"){
      
      gtrends_spark_df <- gtrends_spark_df %>%
        dplyr::select(name, l_death_hits,
                      cor_deathMA7_hitsMA7_max, 
                      cor_deathMA7_hitsMA7_lag,
                      death_total) %>%
        dplyr::rename(Country = name,
                      Trends = l_death_hits,
                      "Correlation" = cor_deathMA7_hitsMA7_max,
                      "Lead/Lag" = cor_deathMA7_hitsMA7_lag)
    } 
    
    #### Sort
    if(!is.null(input$select_sort_by)){
      if(input$select_sort_by %in% "Name"){
        gtrends_spark_df <- gtrends_spark_df %>%
          arrange(Country)
      }
      
      if(input$select_sort_by %in% "Correlation"){
        gtrends_spark_df <- gtrends_spark_df %>%
          arrange(-Correlation)
      }
      
      if(input$select_sort_by %in% "Cases"){
        gtrends_spark_df <- gtrends_spark_df %>%
          arrange(-cases_total)
      }
      
      if(input$select_sort_by %in% "Deaths"){
        gtrends_spark_df <- gtrends_spark_df %>%
          arrange(-death_total)
      }
    }
    
    #### Adjust Variables
    gtrends_spark_df$Correlation <- gtrends_spark_df$Correlation %>% round(3)
    gtrends_spark_df$`Lead/Lag` <- paste(gtrends_spark_df$`Lead/Lag`, "days")
    
    #### Remove Unneeded Variables
    gtrends_spark_df$continent <- NULL
    gtrends_spark_df$death_total <- NULL
    gtrends_spark_df$cases_total <- NULL
    gtrends_spark_df$keyword_en <- NULL
    
    #### Make Table
    #Country	Trends	Correlation	Correlation Lag
    
    f_list <- list(
      `Country` = formatter("span", style = ~ style(color = "black", font.weight = "bold", width = "2px")),
      `Lead/Lag` = formatter("span", style = ~ style(color = "black", font.weight = "bold")),
      # `Correlation` = formatter(
      #   "span",
      #   style = x ~ style(
      #     display = "inline-block",
      #     direction = "lft",
      #     font.weight = "bold",
      #     #"border-radius" = "4px",
      #     "padding-left" = "2px",
      #     "background-color" = csscolor(bar_color),
      #     width = percent(proportion(x)),
      #     color = csscolor("black")
      #   )
      # )
      
      `Correlation` = formatter("span", style = ~ style(color = "black", font.weight = "bold")) #,
    )
    
    gtrends_spark_df <- gtrends_spark_df[!is.na(gtrends_spark_df$Correlation),]
    
    table_max <- nrow(gtrends_spark_df)
    
    l <- formattable(
      gtrends_spark_df[1:table_max,] %>% as.data.table(),
      align = c("c", "c", "l"),
      f_list
    ) %>% format_table(align = c("c", "c", "l", "l")) %>%
      htmltools::HTML() %>%
      div() %>%
      # use new sparkline helper for adding dependency
      spk_add_deps() %>%
      # use column for bootstrap sizing control
      # but could also just wrap in any tag or tagList
      {column(width=12, .)}
    
    l
    
    
  })
  
  # **** Title - Map ---------------------------
  output$map_text <- renderText({
    paste0("<strong>Hover over the map to see trends in <span style='color:orange;'>COVID-19 ",
           tolower(input$select_covid_type),
           "</span> and <span style='color:green;'>search interest in '",
           input$select_keyword, "'</span></strong>")
    
    # paste0("Correlation between COVID-19 ",
    #        tolower(input$select_covid_type),
    #        " and Google search interest. Data after ",
    #        input$select_begin_date, 
    #        " used.")
  })
  
  # ** Max Correlation Dotplot -------------------------------------------------
  # **** Title ---------------------------
  output$cor_distribution_text <- renderText({
    out <- paste0("<strong>Correlation Between COVID-19 ",
                  tolower(input$select_covid_type) %>% tools::toTitleCase(),
                  " and Google Search Interest</strong><br>")
    
    # if(input$select_cor_type %in% "Best Lead/Lag"){
    #   out <- paste0(out,
    #                 " The highest correlation when COVID-19 ", 
    #                 tolower(input$select_covid_type), 
    #                 " are shifted -21 to 21 days is shown.")
    # }
    # 
    # out <- paste0(out, 
    #               " Data after ", 
    #               input$select_begin_date, 
    #               " is used.")
    out
    
  })
  
  output$cor_distribution_text_2 <- renderText({
    # out <- paste0("<strong>Correlation between COVID-19 ",
    #               tolower(input$select_covid_type),
    #               " and Google search interest</strong><br>")
    out <- ""
    
    if(input$select_cor_type %in% "Best Lead/Lag"){
      out <- paste0(out,
                    " The highest correlation when COVID-19 ", 
                    tolower(input$select_covid_type), 
                    " are shifted -21 to 21 days is shown.")
    }
    
    out <- paste0(out, 
                  " Data after ", 
                  input$select_begin_date, 
                  " is used.")
    out
    
  })
  
  # **** Figure ---------------------------
  output$max_cor_hist <- renderPlotly({
    
    cor_df     <- readRDS(file.path("data", paste0("correlations_since_",
                                                   input$select_begin_date,
                                                   ".Rds")))
    
    
    if(input$select_cor_type %in% "No Lead/Lag"){
      cor_df$cor <- cor_df$cor_nolag
    }
    
    if(input$select_search_category != "All"){
      kwords <- keywords_df$keyword_en[keywords_df$category %in% input$select_search_category ]
      cor_df <- cor_df[cor_df$keyword_en %in% kwords,]
    }
    
    if(input$select_continent != "All"){
      cor_df <- cor_df %>%
        dplyr::filter(continent %in% input$select_continent) 
    }
    
    cor_df <- cor_df %>%
      dplyr::filter(type %in% input$select_covid_type) 
    
    cor_df$keyword_en[cor_df$keyword_en %in% "What are the Symptoms of Coronavirus"] <- "What are the Symptoms<br>of Coronavirus"
    cor_df$keyword_en[cor_df$keyword_en %in% "How to Treat Coronavirus"] <- "How to Treat<br>Coronavirus"
    cor_df$keyword_en[cor_df$keyword_en %in% "Unemployment Insurance"] <- "Unemployment<br>Insurance"
    cor_df$keyword_en[cor_df$keyword_en %in% "Unemployment Benefits"] <- "Unemployment<br>Benefits"
    
    
    cor_df$keyword_en <- reorder(cor_df$keyword_en,
                                 cor_df$cor)
    
    
    #fig <- plot_ly(y = ~rnorm(50), type = "box", boxpoints = "all", jitter = 0.3,
    #               pointpos = -1.8)
    
    # https://plotly.com/python/builtin-colorscales/
    # https://community.plotly.com/t/what-colorscales-are-available-in-plotly-and-which-are-the-default/2079
    # cor_df %>%
    #   filter(keyword_en %in% c("Loss of Smell",
    #                            "Fever")) %>%
    #   plot_ly() %>% 
    #   add_markers(y = ~jitter(as.numeric(keyword_en)), 
    #               x = ~cor, 
    #               color = ~cor,
    #               marker = list(size = 6,
    #                             line = list(color = 'black',
    #                                         width = 1),
    #                             #colorscale='Earth', # Viridis
    #                             colorscale = list(list(0,"red"), list(0.5,"white"), list(1,"green")),
    #                             reversescale =F,
    #                             opacity = 1)
    #   )
    
    # https://plotly.com/r/hover-text-and-formatting/
    colors <- brewer.pal(n = 9, 
                         name = "RdYlGn")
    
    p1 <- cor_df %>%
      plot_ly() %>% 
      add_markers(y = ~jitter(as.numeric(keyword_en)), 
                  x = ~cor, 
                  color = ~cor,
                  marker = list(size = 6,
                                line = list(color = 'black',
                                            width = 1),
                                colorscale = list(list(0,"#D73027"), list(0.5,"#FFFFBF"), list(1,"#1A9850")),
                                cauto = F,
                                cmin = -1,
                                cmax = 1,
                                reversescale =F,
                                opacity = 1),
                  #hoverinfo = "text",
                  # text = ~paste0(keyword_en,"<br>",
                  #               "<h4>",  name, "</h4>",
                  #                "<br>",cor %>% round(2)),
                  hovertemplate = ~paste('<b>',name,'</b><br>', 
                                         'Correlation: %{x:.2f}<extra></extra>'),
                  # hovertemplate = paste('<i>Price</i>: $%{cor:.2f}',
                  #                       '<br><b>X</b>: %{x}<br>',
                  #                       '<b>%{text}</b>'),
                  showlegend = F) %>% 
      layout(
        xaxis = list(title = "",
                     range = c((min(cor_df$cor)-.1),1.05),
                     showticklabels = T,
                     side ="top")) %>%
      layout(plot_bgcolor='transparent') %>% 
      layout(paper_bgcolor='transparent') %>%
      layout(margin = list(
        l = 50,
        r = 50,
        b = 100,
        t = 10,
        pad = 4
      )) %>%
      config(displayModeBar = F) %>%
      layout(
        yaxis = list(
          title = "",
          ticktext = as.list(unique(cor_df$keyword_en)), 
          tickvals = as.list(as.numeric(unique(cor_df$keyword_en))),
          tickmode = "array"
        )) %>%
      hide_colorbar() 
    
    
    
    # 
    # p1 <- ggplot() +
    #   geom_dotplot(data = cor_df,
    #                aes(x = reorder(keyword_en,
    #                                cor),
    #                    y = cor,
    #                    fill = "=  One Country"),
    #                binaxis = "y", 
    #                stackdir = "center",
    #                dotsize = 1,
    #                binwidth = .02,
    #                color = "palegreen4") +
    #   scale_fill_manual(values = c("palegreen3")) +
    #   labs(fill = NULL) +
    #   geom_hline(yintercept = 0) +
    #   coord_flip() +
    #   theme_minimal() +
    #   labs(x = "",
    #        y = "Correlation",
    #        title = NULL) +
    #   theme(axis.text.y = element_text(face = "bold", size = 14, color="black"),
    #         axis.title.x = element_text(size = 14, color = "black", face="bold"),
    #         axis.text.x = element_text(size = 14),
    #         legend.text = element_text(size = 14),
    #         legend.position = "top") +
    #   scale_y_continuous(position = "right") 
    # 
    
    
    p1
    
    
  })
  
  # cacheKeyExpr = { list(input$select_begin_date,
  #                       input$select_cor_type,
  #                       input$select_search_category,
  #                       input$select_continent,
  #                       input$select_covid_type)}, bg="transparent")
  # 
  output$max_cor_hist_ui <- renderUI({
    
    height <- "2300px"
    if(input$select_search_category == "Coronavirus General") height <- "600px"
    if(input$select_search_category == "Mental Health") height <- "900px"
    if(input$select_search_category == "Potential Consequences") height <- "500px"
    if(input$select_search_category == "Prevention") height <- "500px"
    if(input$select_search_category == "Symptoms") height <- "970px"
    if(input$select_search_category == "Treatment") height <- "500px"
    
    plotlyOutput("max_cor_hist",
                 height = height)
    
  })
  
  # ** Cor/Lag Title -----------------------------------------------------------
  output$title_cor_lag <- renderText({
    
    cor_df     <- readRDS(file.path("data", paste0("correlations_since_",
                                                   input$select_begin_date,
                                                   ".Rds")))
    
    if(input$select_cor_type %in% "No Lead/Lag"){
      cor_df$cor <- cor_df$cor_nolag
    }
    
    if(input$select_continent != "All"){
      cor_df <- cor_df %>%
        dplyr::filter(continent %in% input$select_continent) 
    }
    
    cor_df <- cor_df %>%
      dplyr::filter(type %in% input$select_covid_type,
                    keyword_en %in% input$select_keyword) 
    
    cor_df <- cor_df %>%
      filter(!is.na(cor))
    
    paste0("<strong>", input$select_keyword,"</strong><br><b><em>",nrow(cor_df), " countries with available data</em></b>")
    
  })
  
  
  # ** Cor Histogram -----------------------------------------------------------
  output$keyword_cor <- renderCachedPlot({
    
    cor_df     <- readRDS(file.path("data", paste0("correlations_since_",
                                                   input$select_begin_date,
                                                   ".Rds")))
    
    if(input$select_cor_type %in% "No Lead/Lag"){
      cor_df$cor <- cor_df$cor_nolag
    }
    
    if(input$select_continent != "All"){
      cor_df <- cor_df %>%
        dplyr::filter(continent %in% input$select_continent) 
    }
    
    cor_df <- cor_df %>%
      dplyr::filter(type %in% input$select_covid_type,
                    keyword_en %in% input$select_keyword) 
    
    cor_sum_df <- cor_df %>%
      ungroup() %>%
      mutate(cor = round(cor*10, 0)/10) %>%
      group_by(cor) %>%
      summarise(N = n()) %>%
      mutate(cor = cor %>% as.factor())
    
    p <- cor_neg1_pos1_df %>%
      left_join(cor_sum_df) %>%
      mutate(N = N %>% replace_na(0)) %>%
      mutate(cor = cor %>% as.character() %>% as.numeric()) %>%
      
      ggplot() +
      geom_col(aes(x = factor(cor), y = N),
               color = "black",
               fill = "palegreen3") +
      labs(title = "Correlation",
           subtitle = paste0("Average: ", round(mean(cor_df$cor), 2)),
           x = NULL,
           y = "Number\nOf\nCountries") +
      scale_x_discrete(labels = c("-1", "",
                                  "-0.8", "",
                                  "-0.6", "",
                                  "-0.4", "",
                                  "-0.2", "",
                                  "0", "",
                                  "0.2", "",
                                  "0.4", "",
                                  "0.6", "",
                                  "0.8", "",
                                  "1", "")) +
      theme_minimal() +
      theme(axis.title.y = element_text(angle = 0,
                                        #family = "Helvetica",
                                        vjust = 0.5),
            plot.title = element_text(face = "bold", size=14,
                                      #family = "Helvetica",
                                      hjust = 0.5),
            plot.subtitle = element_text(face = "bold.italic", 
                                         #family = "Helvetica",
                                         size=12,
                                         hjust = 0.5),
            panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank())
    
    p
  }, cacheKeyExpr = { list(input$select_keyword,
                           input$select_begin_date,
                           input$select_cor_type,
                           input$select_search_category,
                           input$select_continent,
                           input$select_covid_type)})
  
  # ** Lag Histogram -----------------------------------------------------------
  output$keyword_lag <- renderCachedPlot({
    
    cor_df     <- readRDS(file.path("data", paste0("correlations_since_",
                                                   input$select_begin_date,
                                                   ".Rds")))
    
    if(input$select_continent != "All"){
      cor_df <- cor_df %>%
        dplyr::filter(continent %in% input$select_continent) 
    }
    
    cor_df <- cor_df %>%
      dplyr::filter(type %in% input$select_covid_type,
                    keyword_en %in% input$select_keyword) 
    
    cor_df %>%
      ggplot() +
      geom_histogram(aes(x = lag),
                     color = "black",
                     fill = "palegreen3",
                     bins = 15) + 
      labs(title = "Lead/Lag with Highest Correlation",
           subtitle = paste0("Average ", round(mean(cor_df$lag),2), " days"), 
           x = NULL,
           y = "Number\nOf\nCountries") +
      theme_minimal() +
      theme(axis.title.y = element_text(angle = 0,
                                        vjust = 0.5),
            plot.title = element_text(face = "bold", size=14,
                                      hjust = 0.5),
            plot.subtitle = element_text(face = "bold.italic", size=12,
                                         hjust = 0.5),
            panel.grid.major = element_blank(), 
            panel.grid.minor = element_blank())
    
  }, cacheKeyExpr = { list(input$select_keyword,
                           input$select_begin_date,
                           input$select_cor_type,
                           input$select_search_category,
                           input$select_continent,
                           input$select_covid_type)})
  
  # ** Cor Value Box -----------------------------------------------------------
  # output$keyword_cor_box <- renderValueBox({
  #   
  #   cor_df     <- readRDS(file.path("data", paste0("correlations_since_",
  #                                                  input$select_begin_date,
  #                                                  ".Rds")))
  #   
  #   if(input$select_continent != "All"){
  #     cor_df <- cor_df %>%
  #       dplyr::filter(continent %in% input$select_continent) 
  #   }
  #   
  #   cor_df <- cor_df %>%
  #     dplyr::filter(type %in% input$select_covid_type,
  #                   keyword_en %in% input$select_keyword) 
  #   
  #   cor_mean <- cor_df$cor %>% round(2)
  #   
  #   
  #   valueBox(1, 
  #            "Average Correlation", 
  #            icon = icon("database"), 
  #            color = "blue", 
  #            width = 3,
  #            href = NULL)
  #   
  # })
  
  
  
  
  # COUNTRY FIGURES **************** -------------------------------------------
  
  # ** Sparkline Table ---------------------------------------------------------
  #observe({
  output$line_graph_country <- renderUI({
    
    #### Subset
    gtrends_spark_df <- readRDS(file.path("data", 
                                          paste0("gtrends_spark_since_",
                                                 input$select_begin_date_country,"_small.Rds"))) %>%
      filter(name %in% input$select_country)
    
    if(input$select_cor_type_country %in% "No Lead/Lag"){
      gtrends_spark_df$cor_casesMA7_hitsMA7_max <- gtrends_spark_df$cor_casesMA7_hitsMA7_nolag
      gtrends_spark_df$cor_deathMA7_hitsMA7_max <- gtrends_spark_df$cor_deathMA7_hitsMA7_nolag
    }
    
    
    if(input$select_search_category_country != "All"){
      kwords <- keywords_df$keyword_en[keywords_df$category %in% input$select_search_category_country]
      gtrends_spark_df <- gtrends_spark_df[gtrends_spark_df$keyword_en %in% kwords,]
    }
    
    #### COVID Names
    if(input$select_covid_type_map %in% "Cases"){
      gtrends_spark_df <- gtrends_spark_df %>%
        dplyr::select(l_cases_hits, keyword_en,
                      cor_casesMA7_hitsMA7_max, 
                      cor_casesMA7_hitsMA7_lag,
                      cases_total) %>%
        dplyr::rename("Search Term" = keyword_en,
                      Trends = l_cases_hits,
                      "Correlation" = cor_casesMA7_hitsMA7_max,
                      "Lead/Lag" = cor_casesMA7_hitsMA7_lag)
      
      
    } 
    if(input$select_covid_type_map %in% "Deaths"){
      
      gtrends_spark_df <- gtrends_spark_df %>%
        dplyr::select(l_death_hits, keyword_en,
                      cor_deathMA7_hitsMA7_max, 
                      cor_deathMA7_hitsMA7_lag,
                      death_total) %>%
        dplyr::rename("Search Term" = keyword_en,
                      Trends = l_death_hits,
                      "Correlation" = cor_deathMA7_hitsMA7_max,
                      "Lead/Lag" = cor_deathMA7_hitsMA7_lag)
    } 
    
    # Without Lead/Lag ------------------------------------------------------------
    if(input$select_cor_type_country %in% "No Lead/Lag"){
    
    gtrends_spark_df <- gtrends_spark_df %>%
      dplyr::select("Search Term", "Trends", "Correlation")
    
    #### Sort
    gtrends_spark_df <- gtrends_spark_df %>%
      arrange(-Correlation)
    
    #### Adjust Variables
    gtrends_spark_df <- gtrends_spark_df %>%
      mutate(Correlation = Correlation %>% round(3))
    #gtrends_spark_df$Correlation <- gtrends_spark_df$Correlation %>% round(3)
    #gtrends_spark_df$`Lead/Lag` <- paste(gtrends_spark_df$`Lead/Lag`, "days")
    
    #### Make Table
    bar_color <- "#FF9999"
    
    f_list <- list(
      `Search Term` = formatter("span", style = ~ style(color = "black", font.weight = "bold", width = "2px")),
      `Correlation` = formatter(
        "span",
        style = x ~ style(
          display = "inline-block",
          direction = "lft",
          font.weight = "bold",
          #"border-radius" = "4px",
          "padding-left" = "2px",
          "background-color" = csscolor(bar_color),
          width = percent(proportion(x)),
          color = csscolor("black")
        )
      )
      
      #`Correlation` = formatter("span", style = ~ style(color = "black", font.weight = "bold"))
    )
    
    gtrends_spark_df <- gtrends_spark_df[!is.na(gtrends_spark_df$Correlation),]
    
    table_max <- nrow(gtrends_spark_df)
    
    l <- formattable(
      gtrends_spark_df[1:table_max,] %>% as.data.table(),
      align = c("c", "c"),
      f_list
    ) %>% format_table(align = c("c", "c", "l")) %>%
      htmltools::HTML() %>%
      div() %>%
      # use new sparkline helper for adding dependency
      spk_add_deps() %>%
      # use column for bootstrap sizing control
      # but could also just wrap in any tag or tagList
      {column(width=12, .)}
    
    
    
    } else{
      
      gtrends_spark_df <- gtrends_spark_df %>%
        dplyr::select("Search Term", "Trends", "Correlation", "Lead/Lag")
      
      #### Sort
      gtrends_spark_df <- gtrends_spark_df %>%
        arrange(-Correlation)
      
      #### Adjust Variables
      gtrends_spark_df <- gtrends_spark_df %>%
        mutate(Correlation = Correlation %>% round(3),
               `Lead/Lag` = paste(`Lead/Lag`, "days"))
      #gtrends_spark_df$Correlation <- gtrends_spark_df$Correlation %>% round(3)
      #gtrends_spark_df$`Lead/Lag` <- paste(gtrends_spark_df$`Lead/Lag`, "days")
      
      #### Make Table
      bar_color <- "#FF9999"
      
      f_list <- list(
        `Search Term` = formatter("span", style = ~ style(color = "black", font.weight = "bold", width = "2px")),
        `Lead/Lag` = formatter("span", style = ~ style(color = "black", font.weight = "bold")),
        `Correlation` = formatter(
          "span",
          style = x ~ style(
            display = "inline-block",
            direction = "lft",
            font.weight = "bold",
            #"border-radius" = "4px",
            "padding-left" = "2px",
            "background-color" = csscolor(bar_color),
            width = percent(proportion(x)),
            color = csscolor("black")
          )
        )
        
        #`Correlation` = formatter("span", style = ~ style(color = "black", font.weight = "bold"))
      )
      
      gtrends_spark_df <- gtrends_spark_df[!is.na(gtrends_spark_df$Correlation),]
      
      table_max <- nrow(gtrends_spark_df)
      
      l <- formattable(
        gtrends_spark_df[1:table_max,] %>% as.data.table(),
        align = c("c", "c", "l"),
        f_list
      ) %>% format_table(align = c("c", "c", "l", "l")) %>%
        htmltools::HTML() %>%
        div() %>%
        # use new sparkline helper for adding dependency
        spk_add_deps() %>%
        # use column for bootstrap sizing control
        # but could also just wrap in any tag or tagList
        {column(width=12, .)}
      
      
      
    }
    
    l
    
  })
  #})
  
  # ** Historic Trends ---------------------------------------------------------
  # **** Title ------------------------------
  output$line_graph_country_key_title_1 <- renderText({
    paste0("<h4>COVID-19 ", input$select_covid_type_map, " and 
           Search Interest in ", input$select_keyword_country, "</h4>")
  })
  
  output$line_graph_country_key_title_2 <- renderText({
    
    cor_df     <- readRDS(file.path("data", paste0("correlations_since_",
                                                   input$select_begin_date_country,
                                                   ".Rds")))
    
    if(input$select_cor_type_country %in% "No Lead/Lag"){
      cor_df$cor <- cor_df$cor_nolag
    }
    
    cor <- cor_df %>%
      filter(name %in% input$select_country) %>%
      filter(type %in% input$select_covid_type_map) %>%
      filter(keyword_en %in% input$select_keyword_country) 
    
    
    
    # paste0("<b>Using data after ",
    #        input$select_begin_date_country, "<b><br>",
    #        "<ul>",
    #        "<li><b><em>Correlation:</em></b> ", cor$cor %>% round(3), "</li>",
    #        "<li><b><em>Lead/Lag of Highest Correlation:</em></b> ", cor$lag, " days</li>",
    #        "</ul>")
    
    if(input$select_cor_type_country %in% "No Lead/Lag"){
      out <- paste0("<h5><b>Trends in COVID-19 and Search Interest</b><br><br><em>Using data after ",
                    input$select_begin_date_country, 
                    ", the correlation between COVID-19 ",
                    input$select_covid_type_map %>% tolower(), 
                    " and search interest in \"",
                    input$select_keyword_country, 
                    "\" is ",
                    cor$cor %>% round(2),
                    ".</em></h5>")
    } else{
      
      
      out <- paste0("<h5><b>Trends in COVID-19 and Search Interest</b><br><br><em>Using data after ",
                    input$select_begin_date_country, 
                    ", <span style='color:black;'>the correlation between COVID-19 ",
                    input$select_covid_type_map %>% tolower(), 
                    " and search interest in \"",
                    input$select_keyword_country, 
                    "\"</span> is ",
                    cor$cor %>% round(2),
                    " when shifting COVID-19 ",
                    input$select_covid_type_map %>% tolower(),
                    " ",
                    abs(cor$lag),
                    " days into the ",
                    ifelse(cor$lag <= 0, "past", "future"),
                    ".</em></h5>")
    }
    
    
    out    
    
  })
  
  # **** Figure ------------------------------
  output$line_graph_country_key <- renderPlotly({
    
    fig <- plot_ly()
    
    if(!is.null(input$select_keyword_country)){
      if(input$select_keyword_country != ""){
        if(!is.null(input$select_country)){
          if(!is.null(input$select_covid_type_map)){
            
            gtrends_sub_df <- gtrends_df %>%
              filter(keyword_en %in% input$select_keyword_country) %>%
              filter(name %in% input$select_country)
            
            #### COVID Names
            if(input$select_covid_type_map %in% "Cases"){
              gtrends_sub_df <- gtrends_sub_df %>%
                dplyr::select(keyword_en, date, hits_ma7, cases_new) %>%
                dplyr::rename(covid_new = cases_new)
            } 
            if(input$select_covid_type_map %in% "Deaths"){
              gtrends_sub_df <- gtrends_sub_df %>%
                dplyr::select(keyword_en, date, hits_ma7, death_new) %>%
                dplyr::rename(covid_new = death_new)
            } 
            
            multiplier <- max(gtrends_sub_df$covid_new, na.rm=T) / max(gtrends_sub_df$hits_ma7, na.rm=T)
            gtrends_sub_df$hits_ma7_adj <- gtrends_sub_df$hits_ma7 * multiplier
            
            
            gtrends_sub_df <- gtrends_sub_df %>%
              arrange(date)
            
            #aa <<- gtrends_sub_df
            
            fig <- plot_ly(gtrends_sub_df)
            fig <- fig %>% add_trace(x = ~date, y = ~covid_new, type = 'bar', name = input$select_covid_type_map,
                                     marker = list(color = 'orange'),
                                     hoverinfo = "text",
                                     text = ~paste(covid_new %>% prettyNum(big.mark=",",scientific=FALSE), 
                                                   input$select_covid_type_map, 
                                                   "<br>", date))
            fig <- fig %>% add_trace(x = ~date, y = ~hits_ma7, type = 'scatter', mode = 'lines', name = 'Search Interest', yaxis = 'y2',
                                     line = list(color = 'forestgreen'),
                                     hoverinfo = "text",
                                     text = ~paste("Search Interest:", round(hits_ma7, 2),"<br>", date))
            fig <- fig %>% layout(title = '',
                                  xaxis = list(title = ""),
                                  margin = list(l=45, r=45, b=5, t=10, pad=0),
                                  showlegend = F,
                                  #legend = list(orientation = 'h'),
                                  paper_bgcolor = 'transparent',
                                  plot_bgcolor = 'transparent',
                                  yaxis = list(side = 'left', title = input$select_covid_type_map, showgrid = FALSE, zeroline = FALSE, color = "orange"),
                                  yaxis2 = list(side = 'right', 
                                                overlaying = "y", 
                                                rangemode = "tozero",
                                                title = 'Search Interest', 
                                                showgrid = FALSE, 
                                                zeroline = F,
                                                color = "forestgreen")) 
            fig <- fig %>% config(displayModeBar = F)
            
            
            
            
            
            # p <- gtrends_sub_df %>%
            #   ggplot() +
            #   geom_col(aes(x = date, y = covid_new),
            #            fill = color_cases,
            #            color = color_cases) +
            #   geom_line(aes(x = date, y = hits_ma7_adj),
            #             color = color_hits,
            #             size = 1) +
            #   labs(x = NULL, 
            #        y = input$select_covid_type_map) +
            #   scale_y_continuous(sec.axis = sec_axis(~.*1, name = "Search Interest",
            #                                          breaks = c(0, max(gtrends_sub_df$hits_ma7_adj, na.rm=T)),
            #                                          labels = c("Low", "High"))) +
            #   theme_minimal() +
            #   theme(axis.title.y.left = element_text(#angle = 0, 
            #     #vjust = 0.5, 
            #     color=color_cases,
            #     face = "bold",
            #     size=15),
            #     axis.title.y.right = element_text(#angle = 0, 
            #       #vjust = 0.5, 
            #       color=color_hits,
            #       face = "bold",
            #       size=15),
            #     axis.text.y.left = element_text(color = color_cases,
            #                                     size=13),
            #     axis.text.y.right = element_text(color = color_hits,
            #                                      size=13),
            #     axis.text = element_text(face = "bold", size=13),
            #     plot.title = element_text(face = "bold", hjust = 0.5, size=13))
            
          }
        }
      }
    }
    
    fig
    
  }) #  ,bg = "transparent"
  
  
  # ** GTrends HTML ------------------------------------------------------------
  # **** Translation Text ---------------------------
  output$translation_text <- renderText({
    
    geo <- world$geo[world$name %in% input$select_country] %>% as.character()
    
    search_en <- input$select_keyword_country
    language_code <- languges_df$Language_code_main[languges_df$Code %in% geo][1]
    
    if(length(search_en) %in% 0) search_en <- "Loss of Smell"
    if(length(language_code) %in% 0) language_code <- "en"
    
    search <- keywords_df[[paste0("keyword_", language_code)]][tolower(keywords_df$keyword_en) %in% tolower(search_en)]
    search <- search %>% str_replace_all("'", "")
    search_p20 <- search %>% str_replace_all(" ", "%20")
    
    if(language_code %in% "en"){
      out <- ""
    } else{
      out <- paste0("<h4>", "'", search_en[1], "' translated into ",
                    languges_df$Language_main[languges_df$Code %in% geo][1],": ",
                    search[1],
                    "</h4>")
      
      
    }
    
    out 
    
    
  })
  
  # **** Trends ---------------------------
  output$gtrends_html_trends <- renderUI({
    
    # Do this as doesn't appear on default.
    if(!is.null(input$select_country)){
      if((input$select_country %in% "") & LOAD_GTRENDS_INIT){
        updateSelectInput(session, "select_country",
                          selected = "United States")
        LOAD_GTRENDS_INIT <<- F
      }
    }
    
    ## Country
    geo <- world$geo[world$name %in% input$select_country] %>% as.character()
    
    ## Search term
    search_en <- input$select_keyword_country
    language_code <- languges_df$Language_code_main[languges_df$Code %in% geo][1]
    
    if(length(search_en) %in% 0) search_en <- "Loss of Smell"
    if(length(language_code) %in% 0) language_code <- "en"
    
    search <- keywords_df[[paste0("keyword_", language_code)]][tolower(keywords_df$keyword_en) %in% tolower(search_en)]
    search <- search %>% str_replace_all("'", "")
    search_p20 <- search %>% str_replace_all(" ", "%20")
    
    tags$body(HTML(paste0('<script type="text/javascript" src="https://ssl.gstatic.com/trends_nrtr/2213_RC01/embed_loader.js"></script> <script type="text/javascript"> var divElem = document.getElementById("wrapper"); document.getElementById("wrapper").innerHTML = ""; trends.embed.renderExploreWidgetTo(divElem, "TIMESERIES", {"comparisonItem":[{"keyword":"',search,'","geo":"',geo,'","time":"today 3-m"}],"category":0,"property":""}, {"exploreQuery":"q=',search_p20,'&geo=',geo,'&date=today 3-m","guestPath":"https://trends.google.com:443/trends/embed/"}); </script>')))
  })
  
  # **** Map ---------------------------
  output$gtrends_html_map <- renderUI({
    
    # Do this as doesn't appear on default.
    if(!is.null(input$select_country)){
      if((input$select_country %in% "") & LOAD_GTRENDS_INIT){
        updateSelectInput(session, "select_country",
                           selected = "United States")
        LOAD_GTRENDS_INIT <<- F
      }
    }
    
    ## Country
    geo <- world$geo[world$name %in% input$select_country] %>% as.character()
    
    ## Search term
    search_en <- input$select_keyword_country
    language_code <- languges_df$Language_code_main[languges_df$Code %in% geo][1]
    
    if(length(search_en) %in% 0) search_en <- "Loss of Smell"
    if(length(language_code) %in% 0) language_code <- "en"
    
    search <- keywords_df[[paste0("keyword_", language_code)]][tolower(keywords_df$keyword_en) %in% tolower(search_en)]
    search <- search %>% str_replace_all("'", "")
    search_p20 <- search %>% str_replace_all(" ", "%20")
    
    tags$body(HTML(paste0('<script type="text/javascript" src="https://ssl.gstatic.com/trends_nrtr/2213_RC01/embed_loader.js"></script> <script type="text/javascript"> var divElem = document.getElementById("wrapper2"); document.getElementById("wrapper2").innerHTML = ""; trends.embed.renderExploreWidgetTo(divElem, "GEO_MAP", {"comparisonItem":[{"keyword":"',search,'","geo":"',geo,'","time":"today 3-m"}],"category":0,"property":""}, {"exploreQuery":"q=',search_p20,'&geo=',geo,'&date=today 3-m","guestPath":"https://trends.google.com:443/trends/embed/"}); </script>')))
  })
  
  output$country_name <- renderText({
    input$select_country
  })
  
  # INFORMATION ********************* ------------------------------------------
  
  # ** Language Table ----------------------------------------------------------
  output$language_table <- renderTable({
    
    languges_df %>%
      dplyr::select(Name, Language_main) %>%
      dplyr::rename(Country = Name,
                    Language = Language_main) %>%
      dplyr::mutate(Country = Country %>% tools::toTitleCase(),
                    Language = Language %>% 
                      str_replace_all("Chinese (Traditional)",
                                      "Chinese (Simplified)") %>%
                      tools::toTitleCase()) %>%
      distinct(Country, Language) %>%
      arrange(Country)
    
  })
  
  
  # UIS ******************************** ---------------------------------------
  # ** Select Keyword: Global --------------------
  output$select_keyword_ui <- renderUI({
    
    
    out <- selectInput(
      "select_keyword",
      label = strong("Search Term"),
      choices = sort(keyword_list),
      selected = "Loss of Smell",
      multiple = F
    )
    
    if(input$select_search_category != "All"){
      
      keyword_df_i <- keywords_df[keywords_df$category %in% input$select_search_category,]
      
      # If 'Loss of Smell' is a keyword, select that initially
      if("Loss of Smell" %in% keyword_df_i$keyword_en){
        keyword_selected <- "Loss of Smell"
      } else{
        keyword_selected <- sort(keyword_df_i$keyword_en)[1]
      }
      
      out <- selectInput(
        "select_keyword",
        label = strong("Search Term"),
        choices = sort(keyword_df_i$keyword_en),
        selected = keyword_selected,
        multiple = F
      )
      
      
      
    }
    
    out
    
  })
  
  # ** Select Keyword: Country --------------------
  observe({
    
    output$select_keyword_country_ui <- renderUI({
      
      ## Default
      out <- selectInput(
        "select_keyword_country",
        label = strong("Search Term"),
        choices = sort(keyword_list),
        selected = "Loss of Smell",
        multiple = F
      )
      
      ## Restrict to keywords in country
      keywords_in_country <- gtrends_df %>%
        filter(name %in% input$select_country) %>%
        arrange(desc(cor_casesMA7_hitsMA7_max)) %>%
        pull(keyword_en) %>%
        unique()
      
      if(input$select_search_category_country != "All"){
        keywords_vec <- keywords_df$keyword_en[keywords_df$category %in% input$select_search_category_country]
        keywords_in_country <- keywords_in_country[keywords_in_country %in% keywords_vec]
      }
      
      out <- selectInput(
        "select_keyword_country",
        label = strong("Search Term"),
        choices = sort(keywords_in_country),
        selected = keywords_in_country[1],
        multiple = F
      )
      
      out
      
    })
    
  })
  
  # ** Country List - Restrict based on category --------------------
  observe({
    
    output$select_country_ui <- renderUI({
      
      # !!!!!!!!!!!!!!!!!!!!!!!!!! EDIT HERE !!!!!!!!!!!!!!!!!!!!!!!!!!!!!
      
      selected <- "United States"
      
      if(!is.null(input$select_country)){
        if(input$select_country != ""){
          selected <- input$select_country
        }
      }
      
      ## Default
      out <- selectInput(
        "select_country",
        label = strong("Search Country"),
        choices = sort(unique(cor_df$name)),
        selected = "United States",
        multiple = F
      )
      
      cor_country_df <- cor_df
      
      if(input$select_search_category_country != "All"){
        keywords_vec <- keywords_df$keyword_en[keywords_df$category %in% input$select_search_category_country]
        
        cor_country_df <- cor_df[cor_df$keyword_en %in% keywords_vec,]
        
        # If the currently selected country is not in the new list of countries,
        # change selected to United States (default)
        if(!(selected %in% sort(unique(cor_country_df$name)))){
          selected <- "United States"
        }
      }
      
      
      out <- selectInput(
        "select_country",
        label = strong("Search Country"),
        choices = sort(unique(cor_country_df$name)),
        selected = selected,
        multiple = F
      )
      
      out
      
    })
    
  })
  
  
  # * * * * * * * * * * * P U R G A T O R Y * * * * * *  ------------------------
  
  
  
  # ** Global Map ---------------------------------------------------------------
  
  #### Basemap
  output$global_map <- renderLeaflet({
    
    # https://epsg.io/54030
    epsg2163 <- leafletCRS(
      crsClass = "L.Proj.CRS",
      code = "EPSG:4087",
      proj4def = "+proj=eqc +lat_ts=0 +lat_0=0 +lon_0=0 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs ",
      resolutions = 2^(25:15))
    
    # options = leafletOptions(crs = epsg2163)
    
    leaflet() %>%
      addProviderTiles(providers$OpenStreetMap.Mapnik) %>%
      setView(lat = 0, lng = 0, zoom = 1)
    
  })
  
  observe({
    
    req(input$nav == "Country Level") # This makes leaflet show up; before no defaults.
    
    world$name <- NULL
    
    cor_sum_df <- cor_df %>%
      filter(type %in% "Cases") %>% # input$select_covid_type_map
      group_by(geo, name) %>%
      summarise(keyword_en = keyword_en[which.max(cor)])
    
    cor_sum_df$keyword_en[cor_sum_df$keyword_en %in% "Coronavirus Symptoms"] <- "Coronavirus<br>Symptoms"
    cor_sum_df$keyword_en[cor_sum_df$keyword_en %in% "Corona Symptoms"] <- "Corona<br>Symptoms"
    
    world_data <- merge(world, cor_sum_df, by = "geo", all.x=T, all.y=F)
    
    world_data$contain_historic_data <- ifelse(!is.na(world_data$keyword_en),
                                               "Historic Data Available",
                                               NA)
    
    colors <- brewer.pal(n = length(unique(world_data$contain_historic_data)), 
                         name = "Spectral")
    
    pal <- colorFactor(colors, 
                       world_data$contain_historic_data[!is.na(world_data$contain_historic_data)])
    
    leafletProxy("global_map",
                 data = world_data) %>%
      clearShapes() %>%
      clearControls() %>%
      addPolygons(label = ~name,
                  layerId = ~ name,
                  stroke = F,
                  fillOpacity = 1,
                  color = ~pal(contain_historic_data)) %>%
      addLegend("bottomright", 
                pal = pal, 
                values = world_data$contain_historic_data[!is.na(world_data$contain_historic_data)],
                title = "",
                opacity = 1
      )
    
  })
  
  # * Country Figures ----------------------------------------------------------
  
  # *** Country Name Reactive -----
  country_name_react <- reactive({
    
    if(is.null(input$global_map_shape_click$id)){
      country_name <- "United States"
    } else{
      country_name <- input$global_map_shape_click$id
    }
    
    country_name
    
  })
  
  
  
  # *** Country Trends -----------------------------------------------------------
  # country_data_react <- reactive({
  #   
  #   country_name <- country_name_react()
  #   
  #   gtrends_sub_df <- gtrends_df %>%
  #     dplyr::filter(name %in% country_name,
  #                   keyword_en %in% input$select_keyword_map) 
  #   
  #   ## If nrow = 0, give 1 row with just name
  #   if(nrow(gtrends_sub_df) == 0){
  #     
  #     gtrends_sub_df <- bind_rows(gtrends_sub_df,
  #                                 data.frame(name = country_name))
  #     
  #   }
  #   
  #   gtrends_sub_df
  #   
  # })
  
  #observe({
  
  
  #})
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  output$ui_select_covid_cases <- renderUI({
    
    numericInput(
      "select_covid_cases",
      label = strong(paste("Restrict to Countries with X", input$select_covid_type)),
      value = 100,
      min = 0
    )
    
  })
  
  output$country_name <- renderText({
    
    input$select_country
    
  })
  
  output$country_page_description <- renderText({
    
    paste0("Considering all countries, search terms including
                    `Loss of Smell`, `I Can't Smell` and `Loss of Taste` 
                    correlate most strongly with COVID-19 ",
           tolower(input$select_covid_type),
           ". However, other search terms strongly correlate 
                    with COVID trends in select countries. This page shows
                    how well each search term correlates with COVID-19 ",
           tolower(input$select_covid_type),
           " in individual countries.")
    
  })
  
  
  
  output$cor_title_text <- renderText({
    
    paste0("Correlation between search interest in ",
           input$select_keyword, 
           " and COVID-19 ",
           input$select_covid_type)
    
  })
  
  output$trends_title <- renderText({
    
    paste0("Trends in ",
           input$select_keyword,
           " and COVID-19 ",
           input$select_covid_type)
    
  })
  
  output$trends_country_subtitle <- renderText({
    
    out <- paste0("The table compares trends in <span style='color:orange;'>COVID-19 ",
                  tolower(input$select_covid_type), 
                  "</span> and the <span style='color:green;'>search term interest",
                  "</span>.")
    
    if(input$select_cor_type_country %in% "Best Lead/Lag"){
      out <- paste0(out,
                    " The highest correlation when COVID-19 ", 
                    tolower(input$select_covid_type), 
                    " are shifted -21 to 21 days is shown.")
    }
    
    out <- paste0(out, 
                  " Data after ", 
                  input$select_begin_date_country, 
                  " are used to compute the correlation.")    
    out
    
    
  })
  
  output$trends_subtitle <- renderText({
    
    paste0("We compare trends in <span style='color:orange;'>COVID-19 ",
           tolower(input$select_covid_type), 
           "</span> and <span style='color:green;'>search interest in ",
           input$select_keyword, 
           ".</span> We show the correlation between the two and the number of
           days in the past when the search interest is most strongly 
           correlated with COVID-19 ", tolower(input$select_covid_type), 
           ".")
    
    
  })
  
  output$which_keyword_title <- renderText({
    
    paste0("Which search terms are most correlated with COVID-19 ",
           input$select_covid_type, "?")
    
  })
  
  output$text_best_time_lag <- renderText({
    
    if(input$select_continent != "All"){
      cor_df <- cor_df %>%
        dplyr::filter(continent %in% input$select_continent) 
    }
    
    df <- cor_df %>%
      
      dplyr::filter(type %in% input$select_covid_type) %>%
      filter(keyword_en %in% input$select_keyword) 
    
    txt <- paste0("Across countries, the search term interest in ",
                  input$select_keyword,
                  " is most strongly correlated with COVID ",
                  input$select_covid_type, " ",
                  abs(round(mean(df$lag), 0)), " days ",
                  ifelse(round(mean(df$lag), 0) < 0, "into the past", "into the future"),
                  ".")
    
    txt
    
  })
  
  output$text_cor_countries <- renderText({
    
    if(input$select_continent != "All"){
      cor_df <- cor_df %>%
        dplyr::filter(continent %in% input$select_continent) 
    }
    
    df <- cor_df %>%
      
      dplyr::filter(type %in% input$select_covid_type) %>%
      filter(keyword_en %in% input$select_keyword) 
    
    txt <- paste0("Across countries, the average correlation between the search interest in ",
                  input$select_keyword,
                  " and COVID ",
                  input$select_covid_type, 
                  " is ",
                  round(mean(df$cor), 2),
                  ". ",
                  df$name[which.max(df$cor)],
                  " has the strongest correlation (",
                  max(df$cor) %>% round(2),
                  ").")
    
    txt
    
  })
  
  
  output$ui_line_graph <- renderUI({
    
    n_states <- readRDS(file.path("precomputed_figures", 
                                  paste0("stat_line_cor_N_countries",
                                         "_keyword", input$select_keyword,
                                         "_cases_deaths", input$select_covid_type,
                                         "_continent", input$select_continent,
                                         ".Rds")))
    
    n_states_div <- ceiling(n_states/5)
    
    plotOutput("line_graph",
               height = paste0(n_states_div*180,"px"))
    
  })
  
  output$ui_select_sort_by <- renderUI({
    
    selectInput(
      "select_sort_by",
      label = strong("Sort By"),
      choices = c("Name", input$select_covid_type, "Correlation"),
      selected = "Correlation",
      multiple = F
    )
    
  })
  
})

# RUN THE APP ==================================================================
# app <- shinyApp(ui, server)
# 
# profvis({
#   runApp(app, display.mode="normal")
# })

shinyApp(ui, server)



